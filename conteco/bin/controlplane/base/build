#!/usr/bin/env bash
if [[ "$1" == "for-each-node" ]] ; then
(
	shift
    . executionplane-invoke "$0 $@"
	# two build modes: image (root only) and all (images within repository)
	if [[ $# -gt 1 ]] ; then
		method=$1
		if [[ "$method" != "all" && "$method" != "image" ]] ; then
			method="image"
		else
			shift
		fi
	else
		method="image"
	fi
	# set path of node
	if [[ $# -gt 1 ]] ; then
		rootPath="${CONTECO_PWD}/${BASH_ARGV[0]}"
	else
		rootPath="${CONTECO_PWD}/$1"
	fi
	imageName="${CONTECO_REALM}/${CONTECO_ECOSYSTEM}.${CONTECO_TYPE}.${CONTECO_NAME}"
	case $method in
        image)
			if [[ ($1 == "full" && ${CONTECO_TYPE} != "external") || ($1 == "deep" && ${CONTECO_BASE} != "external."*) ]] ; then
				if [[ ${CONTECO_BASE} == *":"* ]] ; then
					executionplane-warning "${CONTECO_BASE} : Specific versions excluded from 'deep' and 'all' switch."
				else
					baseImage=$(echo ${CONTECO_BASE} | cut -f1 -d":")
					build $method ${@:1:$#-1} $baseImage
				fi
			fi
			.container build -t $imageName -f $rootPath/Dockerfile.static $rootPath
            ;;
        all)
			extract-and-execute $imageName build $@
            ;;
		*)
			executionplane-error "Method needs repository node selection for execution."
			;;
	esac
    executionplane-complete
)
else
    export PATH="$CONTECO_EXECUTIONPLANE_APIINTERNALPATH"
	for-each $(basename $0) $@
fi
