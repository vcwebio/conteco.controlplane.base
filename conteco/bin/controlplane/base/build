#!/usr/bin/env bash
if [[ "$1" == "for-each-node" ]] ; then
(
	shift
  . executionplane-invoke "$0 $@"
	# extract build method
	if [[ $# -gt 1 && "$1" == "--deep" ]] ; then
		method="deep"
		rootPath="/conteco/pwd/${BASH_ARGV[0]}"
	else
		rootPath="/conteco/pwd/$1"
	fi
	imageName="${CONTECO_REALM}/${CONTECO_ECOSYSTEM}.${CONTECO_TYPE}.${CONTECO_NAME}"

	# deep build down to base included
	if [[ ($method == "deep" && "${CONTECO_TYPE}" != "external") ]] ; then
		baseImage=$(echo ${CONTECO_BASE} | cut -f1 -d":")
		build ${@:1:$#-1} $baseImage
	fi

	# build latest image
	tmpfile=$(mktemp /tmp/Dockerfile.XXXXXX)
	cat $rootPath/Dockerfile | envsubst > $tmpfile
	executionplane "--errors-only" docker build -t $imageName -f $tmpfile $rootPath
	rm $tmpfile

	# tag latest image
	if [[ "${CONTECO_TAG}" != "" ]] ; then
		executionplane "--errors-only" docker tag "$imageName" "$imageName:${CONTECO_TAG}"
	fi
  executionplane-complete
)
else
  export PATH="$CONTECO_EXECUTIONPLANE_APIINTERNALPATH_BASE"
	for-each $(basename $0) $@
fi
