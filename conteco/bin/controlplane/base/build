#!/usr/bin/env bash
(
	export PATH="$CONTECO_EXECUTIONPLANE_APIINTERNALPATH_BASE"
	. executionplane-invoke "$0 $@"
	imageName="${@: -1}"
	rootPath="/conteco/pwd/${imageName}"
	. $rootPath/environment

	if [[ $# -gt 1 ]] ; then
		if [[ "$1" == "--deep" ]] ; then
			method="deep"
		elif [[ "$1" == "--info" ]] ; then
			. info-summary build
			exit 0
		fi
	fi

	# deep build down to base included
	if [[ ($method == "deep" && "${CONTECO_TYPE}" != "external") ]] ; then
		baseImage=$(echo ${CONTECO_BASE} | cut -f1 -d":")
		build ${@:1:$#-1} $baseImage
	fi

	# build latest image
	tmpfile=$(mktemp /tmp/Dockerfile.XXXXXX)
	cat $rootPath/Dockerfile | envsubst > $tmpfile
	executionplane "--errors-only" docker build -t $imageName -f $tmpfile $rootPath
	rm $tmpfile

	# tag latest image
	if [[ "${CONTECO_TAG}" != "" ]] ; then
		executionplane "--errors-only" docker tag "$imageName" "$imageName:${CONTECO_TAG}"
	fi
  executionplane-complete
)
