#!/usr/bin/env bash
if [[ "$1" == "for-each-node" ]] ; then
(
	shift
    . executionplane-invoke "$0 $@"
	if [[ $# -gt 1 ]] ; then
		method=$1
		shift
	else
		method="all"
	fi
	if [[ $# -gt 1 ]] ; then
		rootPath="${CONTECO_PWD}/${BASH_ARGV[0]}"
	else
		rootPath="${CONTECO_PWD}/$1"
	fi
	imageName="${CONTECO_REALM}/${CONTECO_ECOSYSTEM}.${CONTECO_TYPE}.${CONTECO_NAME}"
	case $method in
		build)
			cat $rootPath/Dockerfile | envsubst > $rootPath/Dockerfile.static
			;;
		extract)
			. executionplane-capture-output .container create $imageName
			destination="${CONTECO_PWD}/${CONTECO_REALM}/${CONTECO_ECOSYSTEM}.${CONTECO_TYPE}.${CONTECO_NAME}"
			executionplane mkdir -p $destination
			.container cp $CONTECO_EXECUTIONPLANE_OUTPUT:/conteco/repo/. $destination
			;;
		load)
			.image pull "$imageName:${CONTECO_TAG}"
			.image tag "$imageName:${CONTECO_TAG}" "$imageName"
			;;
		removecr)
			executionplane-info $rootPath
			shopt -s nullglob
			rootSelections=( "" "/services/*" "/stacks/*" )
			subfolders=( "/docs/*" "/conteco/*" "/conteco/*/*" "/conteco/*/*/*" "/conteco/*/*/*/*" "/conteco/*/*/*/*/*" )
			for rootfolder in "${rootSelections[@]}"
			do
				for f in $rootPath$rootfolder/*;
				do
					if [[ -f $f ]] ; then
						filename=`basename "$f"`
						if [[ $filename != *"."* || $filename == *".static" || $filename == *".md" ]] ; then
							executionplane-info "removing cr in $f"
							dos2unix $f
						fi
					fi
				done;
				for subfolder in "${subfolders[@]}"
				do
					for f in $rootPath$rootfolder$subfolder;
					do
						if [[ -f $f ]] ; then
							if [[ $filename != *"."* || $filename == *".md" ]] ; then
								executionplane-info "removing cr in $f"
								dos2unix $f
							fi
						fi
					done;
				done;
			done
			;;
		unload)
			.image rm "$imageName" $(extract-flags $@)
			.image rm "$imageName:${CONTECO_TAG}" $(extract-flags $@)
			;;
		*)
			executionplane-error "Method needs repository node selection for execution."
			;;
	esac
    executionplane-complete
)
else
    export PATH="$CONTECO_EXECUTIONPLANE_APIINTERNALPATH"
	for-each $(basename $0) $@
fi
