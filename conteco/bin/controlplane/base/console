#!/usr/bin/env bash
(
  export PATH="$CONTECO_EXECUTIONPLANE_APIINTERNALPATH_BASE"
  . executionplane-invoke "$0 $@"
  case $1 in
    --info)
      . info-summary console
    ;;
    clone-repo)
      repoName="$2"
      cd "${CONTECO_REALM_RUNTIME}"
      if [[ ! -d $repoName ]] ; then
        executionplane git clone "$repoName"
      else
        executionplane-warning "Reposiotry folder already exists!"
      fi
      cd ..
		;;
    controlplane-service)
      shift
      controlplane-service $@
    ;;
    execute-selection)
      shift
      console-iterate-selection $@
    ;;
    extract-repo)
      imageName="${CONTECO_REALM_RUNTIME}/${CONTECO_ECOSYSTEM_RUNTIME}.$2"
      if [[ "$3" == "--reload" ]] ; then
        executionplane docker image pull "$CONTECO_REGISTRY$imageName"
      fi
			. executionplane-capture-output docker create ${CONTECO_REGISTRY}$imageName
			destination="/conteco/pwd/$imageName"
			executionplane mkdir -p $destination
			executionplane docker container cp $CONTECO_EXECUTIONPLANE_OUTPUT:/conteco/repo/. $destination
		;;
    load)
      fromTar="false"
      if [[ "$2" == "--from-tar" ]] ; then
        fromTar="true"
        shift
      fi
      imageName="${CONTECO_REALM_RUNTIME}/${CONTECO_ECOSYSTEM_RUNTIME}.$2"
      repo-load "$fromTar" "$imageName"
		;;
    save)
      imageName="${CONTECO_REALM_RUNTIME}/${CONTECO_ECOSYSTEM_RUNTIME}.$2"
      repo-save "$imageName"
		;;
    set-repo-user)
			executionplane git config --global user.name "$2"
			executionplane git config --global user.email "$3"
      executionplane git config --global core.filemode false
		;;
    start-registry)
      port="$2"
      if [[ "$port" == "" ]] ; then
        port="5000"
      fi
      prefix="${CONTECO_ECOSYSTEM_RUNTIME}_registry_base_2"
      registryImage="${CONTECO_REALM_RUNTIME}/${CONTECO_ECOSYSTEM_RUNTIME}.registry.base:2"
      executionplane docker run -d -p "${port}:5000" --restart=always --name "${prefix}" -v "${prefix}_data:/var/lib/registry" "${registryImage}"
		;;
    stop-registry)
      prefix="${CONTECO_ECOSYSTEM_RUNTIME}_registry_base_2"
      registryImage="${CONTECO_REALM_RUNTIME}/${CONTECO_ECOSYSTEM_RUNTIME}.registry.base:2"
      executionplane docker container rm --force "${prefix}"
      executionplane docker volume rm --force "${prefix}_data"
    ;;
    unload)
      imageName="${CONTECO_REALM_RUNTIME}/${CONTECO_ECOSYSTEM_RUNTIME}.$2"
			executionplane docker image rm --force "$CONTECO_REGISTRY$imageName"
      if [[ "$3" != "" ]] ; then
        executionplane docker image rm --force "$CONTECO_REGISTRY$imageName:$3"
			fi
    ;;
   *)
      executionplane-error "Method not recognised: $1."
    ;;
  esac
  executionplane-complete
)
