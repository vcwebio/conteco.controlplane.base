#!/usr/bin/env bash
if [[ "$1" == "for-each-node" ]] ; then
(
	shift
	. executionplane-invoke "$0 $@"
	method=$1
	shift
	# set path of node
	if [[ $# -gt 1 ]] ; then
	rootPath="/conteco/pwd/${BASH_ARGV[0]}"
	else
	rootPath="/conteco/pwd/$1"
	fi
	currentpwd=$(pwd)
	if [[ -d $rootPath ]] ; then
	cd $rootPath
	fi
	echo $rootPath
	imageName="${CONTECO_REALM}/${CONTECO_ECOSYSTEM}.${CONTECO_TYPE}.${CONTECO_NAME}"
	case "$method" in
		add)
			executionplane git add .
		;;
		branch)
			executionplane git branch ${@:1:$#-1}
		;;
		create-workspace)
			# if additional parameter, then original git checkout only
			executionplane git branch "workspace"
			executionplane git checkout "workspace"
		;;
		commit)
			message="${@:1:$#-1}"
			executionplane git commit -m "$(echo "$message")"
		;;
		compact)
			executionplane git reflog expire --updateref --rewrite --stale-fix --expire=all --all
			executionplane git repack -A -d -f -F --window=4095 --depth=4095 --unpack-unreachable=all
			executionplane git prune --expire=all
			executionplane git gc --prune=all --aggressive
			executionplane git push --all
			executionplane git push --tags
		;;
		checkin-workspace)
			executionplane git checkout "${CONTECO_ECOSYSTEM}"
			executionplane git merge workspace
			executionplane git tag -f "${CONTECO_TAG}"
		;;
		config)
			executionplane git remote set-url origin "https://github.com/${CONTECO_REALM}/${CONTECO_ECOSYSTEM}.${CONTECO_TYPE}.${CONTECO_NAME}.git"
			executionplane git config credential.helper store
		;;
		init)
			executionplane git init
		;;
		log)
			executionplane git log ${@:1:$#-1}
		;;
		log10)
			executionplane git log --pretty=format:"%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)<%an>%Creset" --abbrev-commit --date=relative -n 10
			;;
		pull)
			executionplane git pull ${@:1:$#-1}
			;;
		push)
			executionplane "--errors-only" git push origin "${CONTECO_ECOSYSTEM}"
			executionplane "--errors-only" git push -f origin "$CONTECO_TAG"
			;;
		remote)
			executionplane git remote ${@:1:$#-1}
			;;
		remove)
			cd $currentpwd
			executionplane rm -rf $rootPath
		;;
		remove-workspace)
			executionplane git branch -d "workspace"
		;;
		status)
			executionplane git status
			;;
		tag)
			executionplane git tag ${@:1:$#-1}
			;;
		*)
			executionplane-error "Method not recognised: $method."
			;;
	esac
	cd $currentpwd
	executionplane-complete
)
else
(
	export PATH="$CONTECO_EXECUTIONPLANE_APIINTERNALPATH_BASE"
	for-each $(basename $0) $@
)
fi
