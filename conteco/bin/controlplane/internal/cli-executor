#!/usr/bin/env bash
shopt -s nullglob

if [[ "${@: -1}" == "--help" ]] ; then
	.invoke  $@ > >( output-parser-tagged ) 2> >( output-parser-tagged );
	wait-for-output-parser-tagged
else

	selector="$(< ./current-repo-selection)"
	if [[ "$selector" == "" ]] ; then
		selector="${@: -1}"
	else
		storedSelection="true"
	fi

	if [[ " external package " == *"$CONTECO_REPOSITORY_CATEGORY"* ]] ; then
		selector="${CONTECO_REPOSITORY_CATEGORY}.$selector"
	fi

	selector="$(set-selector "$selector")"

	if [[ "$selector" == *"$" ]] ; then
		selector="${selector::-1}"
	else
		selector="$selector*"
	fi

	if [[ "$1" == "console" ]] ; then
	  .invoke $@ > >( output-parser-tagged ) 2> >( output-parser-tagged );
	  wait-for-output-parser-tagged
	else
	  for f in $selector ;
	  do
	    if [[ "$storedSelection" == "true" ]] ; then
				.invoke $1 ${@:2:$#-1} $f > >( output-parser-tagged ) 2> >( output-parser-tagged );
			else
				.invoke $1 ${@:2:$#-2} $f > >( output-parser-tagged ) 2> >( output-parser-tagged );
			fi
	    wait-for-output-parser-tagged
	  done;
	fi
fi
storedSelector="$(< ./current-repo-selection)"
if [[ "$storedSelector" != "" ]] ; then
  printf '%s@' "$storedSelector"
fi
