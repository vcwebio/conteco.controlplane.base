#!/usr/bin/env bash
(
    . executionplane-invoke "$0 $@"
	shopt -s nullglob
    # loop through selections
    contecoDir=$(pwd)
    selector="${BASH_ARGV[0]}"
    if [[ $selector != "${CONTECO_REALM}/${CONTECO_ECOSYSTEM}."* && $selector != "${CONTECO_REALM}/${CONTECO_ECOSYSTEM}" ]] ; then
		if [[ $selector == "${CONTECO_ECOSYSTEM}."* ]] ; then
			selector="${CONTECO_REALM}/${CONTECO_ECOSYSTEM}.${selector}"
		else
			selector="${CONTECO_REALM}/${CONTECO_ECOSYSTEM}.${selector}"
		fi
    fi
    for f in $selector*;
    do
    (
        # apply environment
        if [[ -d $f ]] ; then
            . ./$f/environment
        else 
            withoutrealm=$( echo ${BASH_ARGV[0]} | cut -d '/' -f 2)
            export CONTECO_TYPE=$( echo $withoutrealm | cut -d '.' -f 1)
            export CONTECO_NAME=$( echo $withoutrealm | cut -d '.' -f 2)
            export CONTECO_TAG=""
        fi

		# extract command from arguments
		command=$1
		shift

        # execute command for current selector.
		# first argument indicates it was processed by foreach
        $command for-each-node ${@:1:$#-1} $f
    )
    done;
    . executionplane-complete
)